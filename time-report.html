<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Time Tracking Report</title>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
    <div class="time-report-container">
        <!-- Report Header -->
        <div class="report-header">
            <h2>Time Tracking Report</h2>
            <div class="report-summary">
                <div class="summary-item">
                    <span class="label">Total Board Time:</span>
                    <span id="totalBoardTime" class="value">0h 0m</span>
                </div>
                <div class="summary-item">
                    <span class="label">Cards with Time:</span>
                    <span id="cardsWithTime" class="value">0</span>
                </div>
            </div>
        </div>

        <!-- Filter Options -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="listFilter">Filter by List:</label>
                <select id="listFilter" class="form-control">
                    <option value="">All Lists</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="dateFilter">Filter by Date:</label>
                <select id="dateFilter" class="form-control">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="thisWeek">This Week</option>
                    <option value="lastWeek">Last Week</option>
                    <option value="thisMonth">This Month</option>
                    <option value="lastMonth">Last Month</option>
                </select>
            </div>
        </div>

        <!-- Cards Time Report -->
        <div class="cards-report">
            <h3>Cards Time Breakdown</h3>
            <div id="cardsReportList" class="report-list">
                <!-- Cards will be populated here -->
            </div>
        </div>

        <!-- Export Options -->
        <div class="export-section">
            <h3>Export Options</h3>
            <div class="export-buttons">
                <button id="exportCsvBtn" class="btn btn-secondary">Export to CSV</button>
                <button id="exportJsonBtn" class="btn btn-secondary">Export to JSON</button>
            </div>
        </div>
    </div>

    <script>
        /* global TrelloPowerUp */
        
        const t = TrelloPowerUp.iframe();
        
        async function init() {
            try {
                console.log('Initializing time report...');
                const boardData = await t.board('id', 'name', 'lists', 'cards');
                console.log('Board data loaded:', boardData);
                
                let allTimeData = [];
                
                for (const card of boardData.cards) {
                    try {
                        const timeData = await t.get(card.id, 'shared', 'timeTracker', {});
                        console.log(`Card ${card.name} time data:`, timeData);
                        
                        // Check if card has any time tracking data
                        if (timeData && (timeData.totalTime > 0 || timeData.isTracking || (timeData.entries && timeData.entries.length > 0))) {
                            allTimeData.push({ card, timeData });
                        }
                    } catch (error) {
                        console.error(`Error loading time data for card ${card.id}:`, error);
                    }
                }
                
                console.log('All time data loaded:', allTimeData);
                renderReport(allTimeData, boardData);
            } catch (error) {
                console.error('Error initializing time report:', error);
                showError('Failed to load time report data');
            }
        }

        function renderReport(data, boardData) {
            console.log('Rendering report with data:', data);
            
            // Calculate total time including active sessions
            const totalTime = data.reduce((sum, item) => {
                let itemTime = item.timeData.totalTime || 0;
                
                // Add current session time if tracking
                if (item.timeData.isTracking && item.timeData.startTime) {
                    const currentSession = Math.round((Date.now() - item.timeData.startTime) / 1000);
                    itemTime += currentSession;
                }
                
                return sum + itemTime;
            }, 0);
            
            console.log('Total time calculated:', totalTime);
            
            document.getElementById('totalBoardTime').textContent = formatTime(totalTime);
            document.getElementById('cardsWithTime').textContent = data.length;
            
            const container = document.getElementById('cardsReportList');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="no-data">No time tracking data found. Try tracking some time on cards first!</div>';
                return;
            }
            
            // Sort by total time descending
            data.sort((a, b) => {
                let timeA = a.timeData.totalTime || 0;
                let timeB = b.timeData.totalTime || 0;
                
                if (a.timeData.isTracking && a.timeData.startTime) {
                    timeA += Math.round((Date.now() - a.timeData.startTime) / 1000);
                }
                if (b.timeData.isTracking && b.timeData.startTime) {
                    timeB += Math.round((Date.now() - b.timeData.startTime) / 1000);
                }
                
                return timeB - timeA;
            });
            
            container.innerHTML = data.map(item => {
                let displayTime = item.timeData.totalTime || 0;
                let isTracking = item.timeData.isTracking;
                
                if (isTracking && item.timeData.startTime) {
                    const currentSession = Math.round((Date.now() - item.timeData.startTime) / 1000);
                    displayTime += currentSession;
                }
                
                const listName = boardData.lists.find(l => l.id === item.card.idList)?.name || 'Unknown List';
                const entriesCount = item.timeData.entries ? item.timeData.entries.length : 0;
                
                return `
                    <div class="card-report-item ${isTracking ? 'tracking' : ''}">
                        <div class="card-info">
                            <div class="card-name">${item.card.name}</div>
                            <div class="card-list">${listName}</div>
                        </div>
                        <div class="time-info">
                            <div class="total-time">${formatTime(displayTime)}</div>
                            <div class="entries-count">${entriesCount} entries</div>
                            ${isTracking ? '<div class="tracking-indicator">⏲️ Currently tracking</div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showError(message) {
            const container = document.getElementById('cardsReportList');
            container.innerHTML = `<div class="error-message">❌ ${message}</div>`;
        }

        function formatTime(seconds) {
            if (!seconds || seconds < 0) return '0h 0m';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 